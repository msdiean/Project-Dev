pipeline {
    agent any

    tools {
        nodejs 'nodejs'
    }

    environment {
        SCANNER_HOME = tool 'sonar-scanner'

        AWS_DEFAULT_REGION = 'ap-south-1'
        AWS_ECR_REPO_NAME  = 'frontend'
        AWS_ACCOUNT_ID     = '767828733016'

        REPOSITORY_URI = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
        IMAGE_TAG      = "${BUILD_NUMBER}"

        GIT_REPO_NAME  = 'Project-Dev'
        GIT_USER_NAME  = 'msdiean'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Application Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/msdiean/Project-Dev.git'
            }
        }

        stage('NPM Install & Unit Test') {
            steps {
                dir('app/frontend') {
                    sh '''
                        export NODE_OPTIONS=--openssl-legacy-provider
                        npm install
                        npm test -- --watch=false --passWithNoTests
                    '''
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('app/frontend') {
                    withSonarQubeEnv('sonar-server') {
                        sh """
                            ${SCANNER_HOME}/bin/sonar-scanner \
                            -Dsonar.projectName=three-tier-frontend \
                            -Dsonar.projectKey=three-tier-frontend \
                            -Dsonar.sources=src \
                            -Dsonar.exclusions=node_modules/**,build/**
                        """
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    waitForQualityGate abortPipeline: false
                }
            }
        }

        stage('OWASP Dependency Check (Report Only)') {
            steps {
                dir('app/frontend') {
                    dependencyCheck(
                        additionalArguments: '--scan ./ --disableNodeAudit --disableYarnAudit',
                        odcInstallation: 'DP-Check'
                    )
                    dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                }
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                    docker build \
                      -f docker/dockerfiles/frontend/Dockerfile \
                      -t ${AWS_ECR_REPO_NAME}:latest \
                      app/frontend
                '''
            }
        }

        stage('Trivy Scan (Report Only)') {
            steps {
                sh '''
                    trivy image \
                      --severity HIGH,CRITICAL \
                      --exit-code 0 \
                      ${AWS_ECR_REPO_NAME}:latest
                '''
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-jenkins-creds']
                ]) {
                    sh '''
                        aws ecr get-login-password \
                          --region ${AWS_DEFAULT_REGION} \
                        | docker login \
                          --username AWS \
                          --password-stdin ${REPOSITORY_URI}
                    '''
                }
            }
        }

        stage('Tag & Push Image') {
            steps {
                sh '''
                    docker tag ${AWS_ECR_REPO_NAME}:latest \
                        ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${IMAGE_TAG}

                    docker tag ${AWS_ECR_REPO_NAME}:latest \
                        ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:latest

                    docker push ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${IMAGE_TAG}
                    docker push ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:latest
                '''
            }
        }

        stage('Update GitOps Repo (Helm values)') {
            steps {
                withCredentials([
                    string(credentialsId: 'gh-token', variable: 'GH_TOKEN')
                ]) {
                    sh '''
                        git config --global user.email "jenkins@ci.com"
                        git config --global user.name "jenkins"

                        sed -i 's|tag:.*|tag: "'"${IMAGE_TAG}"'"|' \
                            k8s/helm/frontend/values.yaml

                        git add k8s/helm/frontend/values.yaml
                        git commit -m "Update frontend image to ${IMAGE_TAG}"
                        git push https://${GH_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "CI complete. Argo CD will deploy automatically."
        }
        failure {
            echo "Pipeline failed"
        }
    }
}
